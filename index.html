// Google Apps Script para integração com o sistema de vendas
// Cole este código no Google Apps Script (script.google.com)

function doGet(e) {
  try {
    const action = e.parameter.action;

    switch (action) {
      case "abrirCaixa":
        return ContentService.createTextOutput(
          JSON.stringify(abrirCaixa())
        ).setMimeType(ContentService.MimeType.JSON);
      case "adicionarVenda":
        const venda = JSON.parse(e.parameter.venda);
        return ContentService.createTextOutput(
          JSON.stringify(adicionarVenda(venda))
        ).setMimeType(ContentService.MimeType.JSON);
      case "carregarVendas":
        return ContentService.createTextOutput(
          JSON.stringify(carregarVendas(e.parameter.data))
        ).setMimeType(ContentService.MimeType.JSON);
      case "carregarCategorias":
        return ContentService.createTextOutput(
          JSON.stringify(carregarCategorias())
        ).setMimeType(ContentService.MimeType.JSON);
      case "excluirVenda":
        return ContentService.createTextOutput(
          JSON.stringify(excluirVenda(e.parameter.item))
        ).setMimeType(ContentService.MimeType.JSON);
      default:
        return ContentService.createTextOutput(
          JSON.stringify({
            success: false,
            message: "Ação não reconhecida",
          })
        ).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(
      JSON.stringify({
        success: false,
        message: "Erro no servidor: " + error.message,
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    switch (data.action) {
      case "abrirCaixa":
        return ContentService.createTextOutput(
          JSON.stringify(abrirCaixa())
        ).setMimeType(ContentService.MimeType.JSON);
      case "adicionarVenda":
        return ContentService.createTextOutput(
          JSON.stringify(adicionarVenda(data.venda))
        ).setMimeType(ContentService.MimeType.JSON);
      case "carregarVendas":
        return ContentService.createTextOutput(
          JSON.stringify(carregarVendas(data.data))
        ).setMimeType(ContentService.MimeType.JSON);
      case "carregarCategorias":
        return ContentService.createTextOutput(
          JSON.stringify(carregarCategorias())
        ).setMimeType(ContentService.MimeType.JSON);
      case "excluirVenda":
        return ContentService.createTextOutput(
          JSON.stringify(excluirVenda(data.item))
        ).setMimeType(ContentService.MimeType.JSON);
      default:
        return ContentService.createTextOutput(
          JSON.stringify({
            success: false,
            message: "Ação não reconhecida",
          })
        ).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(
      JSON.stringify({
        success: false,
        message: "Erro no servidor: " + error.message,
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

function abrirCaixa() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();

    // Verifica se a aba "movimento" já existe
    let sheetMovimento = spreadsheet.getSheetByName("movimento");

    if (!sheetMovimento) {
      // Cria nova aba "movimento"
      sheetMovimento = spreadsheet.insertSheet("movimento");

      // Configura o cabeçalho
      const cabecalho = [
        "Item",
        "Produto",
        "Categoria",
        "Pagamento",
        "Valor",
        "Observações",
        "Data",
      ];
      sheetMovimento.getRange(1, 1, 1, cabecalho.length).setValues([cabecalho]);

      // Formata o cabeçalho
      const headerRange = sheetMovimento.getRange(1, 1, 1, cabecalho.length);
      headerRange.setBackground("#4CAF50");
      headerRange.setFontColor("white");
      headerRange.setFontWeight("bold");
      headerRange.setHorizontalAlignment("center");

      // Ajusta largura das colunas
      sheetMovimento.setColumnWidth(1, 60); // Item
      sheetMovimento.setColumnWidth(2, 200); // Produto
      sheetMovimento.setColumnWidth(3, 120); // Categoria
      sheetMovimento.setColumnWidth(4, 150); // Pagamento
      sheetMovimento.setColumnWidth(5, 100); // Valor
      sheetMovimento.setColumnWidth(6, 250); // Observações
      sheetMovimento.setColumnWidth(7, 100); // Data

      // Adiciona formatação de moeda na coluna Valor
      sheetMovimento.getRange(2, 5, 1000, 1).setNumberFormat("R$ #,##0.00");

      // Adiciona formatação de data na coluna Data
      sheetMovimento.getRange(2, 7, 1000, 1).setNumberFormat("dd/mm/yyyy");
    }

    // Verifica se a aba "categorias" existe, se não, cria com categorias padrão
    let sheetCategorias = spreadsheet.getSheetByName("categorias");

    if (!sheetCategorias) {
      sheetCategorias = spreadsheet.insertSheet("categorias");

      // Configura o cabeçalho da aba categorias
      const cabecalhoCategorias = ["Categoria"];
      sheetCategorias
        .getRange(1, 1, 1, cabecalhoCategorias.length)
        .setValues([cabecalhoCategorias]);

      // Formata o cabeçalho
      const headerRangeCategorias = sheetCategorias.getRange(
        1,
        1,
        1,
        cabecalhoCategorias.length
      );
      headerRangeCategorias.setBackground("#FF9800");
      headerRangeCategorias.setFontColor("white");
      headerRangeCategorias.setFontWeight("bold");
      headerRangeCategorias.setHorizontalAlignment("center");

      // Adiciona categorias padrão
      const categoriasDefault = [["Acessórios"], ["Brinquedos"]];

      sheetCategorias
        .getRange(2, 1, categoriasDefault.length, 1)
        .setValues(categoriasDefault);

      // Ajusta largura da coluna
      sheetCategorias.setColumnWidth(1, 150);
    }

    return {
      success: true,
      message: "Sistema inicializado com sucesso",
      nomeAba: "movimento",
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao inicializar sistema: " + error.message,
    };
  }
}

function adicionarVenda(venda) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheetMovimento = spreadsheet.getSheetByName("movimento");

    if (!sheetMovimento) {
      // Se a aba não existir, inicializa o sistema primeiro
      const resultadoAbrirCaixa = abrirCaixa();
      if (!resultadoAbrirCaixa.success) {
        return resultadoAbrirCaixa;
      }
      sheetMovimento = spreadsheet.getSheetByName("movimento");
    }

    // Encontra a próxima linha vazia
    const proximaLinha = sheetMovimento.getLastRow() + 1;

    // Formata a data para DD/MM/AAAA
    const dataVenda = new Date(venda.timestamp);
    const dataFormatada = Utilities.formatDate(
      dataVenda,
      Session.getScriptTimeZone(),
      "dd/MM/yyyy"
    );

    // Dados da venda
    const dadosVenda = [
      venda.item,
      venda.produto,
      venda.categoria,
      venda.pagamento,
      venda.valor,
      venda.observacoes || "",
      dataFormatada,
    ];

    // Insere os dados
    sheetMovimento
      .getRange(proximaLinha, 1, 1, dadosVenda.length)
      .setValues([dadosVenda]);

    // Aplica formatação alternada nas linhas
    if (proximaLinha % 2 === 0) {
      sheetMovimento
        .getRange(proximaLinha, 1, 1, dadosVenda.length)
        .setBackground("#f8f9fa");
    }

    // Adiciona formatação especial para categoria
    const categoriaCell = sheetMovimento.getRange(proximaLinha, 3);
    if (venda.categoria === "Acessórios") {
      categoriaCell.setBackground("#e1f5fe");
      categoriaCell.setFontColor("#01579b");
    } else if (
      venda.categoria === "Brinquedos" ||
      venda.categoria === "Brinquedo"
    ) {
      categoriaCell.setBackground("#fff3e0");
      categoriaCell.setFontColor("#e65100");
    }

    return {
      success: true,
      message: "Venda adicionada com sucesso",
      linha: proximaLinha,
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao adicionar venda: " + error.message,
    };
  }
}

function carregarVendas(data) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetMovimento = spreadsheet.getSheetByName("movimento");

    if (!sheetMovimento) {
      return {
        success: true,
        vendas: [],
        message: "Aba movimento não encontrada",
      };
    }

    const ultimaLinha = sheetMovimento.getLastRow();

    if (ultimaLinha <= 1) {
      return {
        success: true,
        vendas: [],
        message: "Nenhuma venda encontrada",
      };
    }

    // Carrega todos os dados (exceto o cabeçalho)
    const dadosRange = sheetMovimento.getRange(2, 1, ultimaLinha - 1, 7);
    const dados = dadosRange.getValues();

    // Formata a data de filtro para comparação
    const dataFiltro = new Date(data + "T00:00:00");
    const dataFiltroFormatada = Utilities.formatDate(
      dataFiltro,
      Session.getScriptTimeZone(),
      "dd/MM/yyyy"
    );

    // Filtra vendas pela data
    const vendasFiltradas = dados.filter((linha) => {
      const dataVenda = linha[6]; // Coluna Data

      // Se a data da venda é um objeto Date, formata para comparar
      if (dataVenda instanceof Date) {
        const dataVendaFormatada = Utilities.formatDate(
          dataVenda,
          Session.getScriptTimeZone(),
          "dd/MM/yyyy"
        );
        return dataVendaFormatada === dataFiltroFormatada;
      }

      // Se a data da venda já é string, compara diretamente
      return dataVenda === dataFiltroFormatada;
    });

    // Ordena do mais recente para o mais antigo (item decrescente)
    vendasFiltradas.sort(function (a, b) {
      return (parseInt(b[0], 10) || 0) - (parseInt(a[0], 10) || 0);
    });

    const vendas = vendasFiltradas.map((linha) => ({
      item: linha[0],
      produto: linha[1],
      categoria: linha[2],
      pagamento: linha[3],
      valor: linha[4],
      observacoes: linha[5],
      data: linha[6],
    }));

    return {
      success: true,
      vendas: vendas,
      message: `${vendas.length} vendas encontradas para ${dataFiltroFormatada}`,
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao carregar vendas: " + error.message,
    };
  }
}

function carregarCategorias() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheetCategorias = spreadsheet.getSheetByName("categorias");

    if (!sheetCategorias) {
      return {
        success: false,
        categorias: [],
        message:
          "Aba de categorias não encontrada. Crie a aba 'categorias' na planilha.",
      };
    }

    const ultimaLinha = sheetCategorias.getLastRow();

    if (ultimaLinha <= 1) {
      return {
        success: false,
        categorias: [],
        message:
          "Nenhuma categoria encontrada. Adicione categorias na aba 'categorias'.",
      };
    }

    // Carrega as categorias (exceto o cabeçalho)
    const dadosRange = sheetCategorias.getRange(2, 1, ultimaLinha - 1, 1);
    const dados = dadosRange.getValues();

    const categorias = dados
      .map((linha) => linha[0])
      .filter((categoria) => categoria && categoria.trim() !== "");

    return {
      success: true,
      categorias: categorias,
      message: "Categorias carregadas com sucesso",
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao carregar categorias: " + error.message,
    };
  }
}

function excluirVenda(item) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetMovimento = spreadsheet.getSheetByName("movimento");

    if (!sheetMovimento) {
      return {
        success: false,
        message: "Aba movimento não encontrada",
      };
    }

    const ultimaLinha = sheetMovimento.getLastRow();

    if (ultimaLinha <= 1) {
      return {
        success: false,
        message: "Nenhuma venda encontrada para excluir",
      };
    }

    // Busca a linha com o item especificado
    const range = sheetMovimento.getRange(2, 1, ultimaLinha - 1, 1); // Coluna A (Item)
    const valores = range.getValues();

    let linhaParaExcluir = -1;
    for (let i = 0; i < valores.length; i++) {
      if (valores[i][0] == item) {
        linhaParaExcluir = i + 2; // +2 porque começamos na linha 2
        break;
      }
    }

    if (linhaParaExcluir === -1) {
      return {
        success: false,
        message: "Item não encontrado",
      };
    }

    // Backup da linha antes de excluir (para log)
    const linhaBackup = sheetMovimento
      .getRange(linhaParaExcluir, 1, 1, 7)
      .getValues()[0];

    // Exclui a linha
    sheetMovimento.deleteRow(linhaParaExcluir);

    // Log da exclusão
    Logger.log(
      `Venda excluída - Item: ${item}, Produto: ${linhaBackup[1]}, Categoria: ${linhaBackup[2]}, Valor: ${linhaBackup[4]}`
    );

    return {
      success: true,
      message: "Venda excluída com sucesso",
      item: item,
      produtoExcluido: linhaBackup[1],
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao excluir venda: " + error.message,
    };
  }
}

// Função para testar a integração
function testarIntegracao() {
  Logger.log("Testando integração...");

  // Testa abrir caixa (inicializar sistema)
  const resultadoAbrirCaixa = abrirCaixa();
  Logger.log("Resultado inicializar sistema:", resultadoAbrirCaixa);

  // Testa carregar categorias
  const resultadoCategorias = carregarCategorias();
  Logger.log("Resultado carregar categorias:", resultadoCategorias);

  // Testa adicionar venda
  const vendaTeste = {
    item: 1,
    produto: "Produto Teste",
    categoria: "Acessórios",
    pagamento: "Dinheiro",
    valor: 10.5,
    observacoes: "Teste de integração",
    timestamp: new Date().toISOString(),
  };

  const resultadoVenda = adicionarVenda(vendaTeste);
  Logger.log("Resultado adicionar venda:", resultadoVenda);

  // Testa carregar vendas
  const hoje = new Date().toISOString().split("T")[0];
  const resultadoCarregar = carregarVendas(hoje);
  Logger.log("Resultado carregar vendas:", resultadoCarregar);
}

// Função para configurar permissões iniciais
function configurarPermissoes() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  Logger.log("Planilha configurada:", spreadsheet.getName());
  Logger.log("URL da planilha:", spreadsheet.getUrl());

  // Inicializa o sistema
  const resultado = abrirCaixa();
  Logger.log("Sistema inicializado:", resultado);
}

// Função para obter estatísticas das vendas por período
function obterEstatisticas(dataInicio, dataFim) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetMovimento = spreadsheet.getSheetByName("movimento");

    if (!sheetMovimento || sheetMovimento.getLastRow() <= 1) {
      return {
        success: true,
        estatisticas: {
          totalVendas: 0,
          valorTotal: 0,
          ticketMedio: 0,
          formasPagamento: {},
          categorias: {},
        },
      };
    }

    const ultimaLinha = sheetMovimento.getLastRow();
    const dados = sheetMovimento.getRange(2, 1, ultimaLinha - 1, 7).getValues();

    let valorTotal = 0;
    const formasPagamento = {};
    const categorias = {};

    dados.forEach((linha) => {
      const valor = parseFloat(linha[4]);
      const pagamento = linha[3];
      const categoria = linha[2];

      valorTotal += valor;

      if (formasPagamento[pagamento]) {
        formasPagamento[pagamento] += valor;
      } else {
        formasPagamento[pagamento] = valor;
      }

      if (categorias[categoria]) {
        categorias[categoria] += valor;
      } else {
        categorias[categoria] = valor;
      }
    });

    const estatisticas = {
      totalVendas: dados.length,
      valorTotal: valorTotal,
      ticketMedio: dados.length > 0 ? valorTotal / dados.length : 0,
      formasPagamento: formasPagamento,
      categorias: categorias,
    };

    return {
      success: true,
      estatisticas: estatisticas,
    };
  } catch (error) {
    return {
      success: false,
      message: "Erro ao obter estatísticas: " + error.message,
    };
  }
}
