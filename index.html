<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Controle de Vendas</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        animation: pulse 4s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.3;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.1;
        }
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
        position: relative;
        z-index: 2;
      }

      .main-content {
        padding: 40px;
      }

      .status-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #4caf50;
      }

      .status-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .status-item {
        flex: 1;
        min-width: 200px;
      }

      .status-item h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .status-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #4caf50;
      }

      .btn-primary {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .btn-danger {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      }

      .btn-danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
      }

      .btn-danger:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-small {
        padding: 6px 10px;
        font-size: 0.8em;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .modal-content h3 {
        color: #f44336;
        margin-bottom: 20px;
      }

      .modal-content p {
        margin-bottom: 25px;
        color: #666;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }

      .form-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px solid #e9ecef;
      }

      .form-section h2 {
        color: #333;
        margin-bottom: 25px;
        font-size: 1.5em;
        text-align: center;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 1em;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 60px;
      }

      .vendas-list {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .vendas-list h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      .vendas-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .vendas-table th,
      .vendas-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .vendas-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
      }

      .vendas-table tr:hover {
        background: #f8f9fa;
      }

      .total-display {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
      }

      .total-display h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }

      .total-value {
        font-size: 2em;
        font-weight: bold;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        position: relative;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .config-section {
        background: #fff3cd;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid #ffeaa7;
      }

      .config-section h3 {
        color: #856404;
        margin-bottom: 15px;
      }

      .config-section p {
        color: #856404;
        margin-bottom: 10px;
      }

      .config-section input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2em;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .status-info {
          flex-direction: column;
          align-items: stretch;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí∞ Sistema de Controle de Vendas</h1>
        <p>Gerencie suas vendas di√°rias de forma inteligente e automatizada</p>
      </div>

      <div class="main-content">
        <!-- Se√ß√£o de Configura√ß√£o -->
        <div class="config-section" id="configSection">
          <h3>‚öôÔ∏è Configura√ß√£o Inicial</h3>
          <p>
            Para come√ßar, voc√™ precisa configurar a integra√ß√£o com o Google
            Sheets:
          </p>
          <div class="form-group">
            <label for="sheetUrl">URL do Google Sheets:</label>
            <input
              type="url"
              id="sheetUrl"
              placeholder="https://docs.google.com/spreadsheets/d/SEU_ID_AQUI/edit"
            />
          </div>
          <div class="form-group">
            <label for="webAppUrl">URL do Google Apps Script (Web App):</label>
            <input
              type="url"
              id="webAppUrl"
              placeholder="https://script.google.com/macros/s/SEU_ID_AQUI/exec"
            />
          </div>
          <button class="btn-primary" onclick="salvarConfiguracao()">
            Salvar Configura√ß√£o
          </button>
        </div>

        <!-- Status do Sistema -->
        <div class="status-section">
          <div class="status-info">
            <div class="status-item">
              <h3>üìÖ Data Atual</h3>
              <div class="status-value" id="dataAtual">--</div>
            </div>
            <div class="status-item">
              <h3>üè™ Status do Caixa</h3>
              <div class="status-value" id="statusCaixa">Fechado</div>
            </div>
            <div class="status-item">
              <h3>üìä Vendas do Dia</h3>
              <div class="status-value" id="vendasDia">0</div>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: center">
            <button
              class="btn-primary"
              id="btnAbrirCaixa"
              onclick="abrirCaixa()"
            >
              üîì Abrir Caixa
            </button>
          </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Formul√°rio de Vendas -->
        <div class="form-section" id="formSection" style="display: none">
          <h2>üìù Registrar Nova Venda</h2>
          <form id="vendaForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="produto">Produto:</label>
                <input type="text" id="produto" required />
              </div>
              <div class="form-group">
                <label for="pagamento">Tipo de Pagamento:</label>
                <select id="pagamento" required>
                  <option value="">Selecione...</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                  <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                  <option value="PIX">PIX</option>
                  <option value="Boleto">Boleto</option>
                </select>
              </div>
              <div class="form-group">
                <label for="valor">Valor (R$):</label>
                <input type="number" id="valor" step="0.01" min="0" required />
              </div>
              <div class="form-group">
                <label for="observacoes">Observa√ß√µes:</label>
                <textarea
                  id="observacoes"
                  placeholder="Informa√ß√µes adicionais..."
                ></textarea>
              </div>
            </div>
            <div style="text-align: center">
              <button type="submit" class="btn-primary">
                ‚ûï Adicionar Venda
              </button>
            </div>
          </form>
        </div>

        <!-- Lista de Vendas -->
        <div class="vendas-list" id="vendasList" style="display: none">
          <h2>üìã Vendas de Hoje</h2>
          <table class="vendas-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Produto</th>
                <th>Pagamento</th>
                <th>Valor</th>
                <th>Observa√ß√µes</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="vendasTableBody">
              <!-- Vendas ser√£o inseridas aqui -->
            </tbody>
          </table>

          <div class="total-display">
            <h3>üí∞ Total de Vendas do Dia</h3>
            <div class="total-value" id="totalVendas">R$ 0,00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="modalExclusao" class="modal">
      <div class="modal-content">
        <h3>‚ö†Ô∏è Confirmar Exclus√£o</h3>
        <p>Tem certeza que deseja excluir esta venda?</p>
        <div id="vendaDetalhes"></div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="fecharModal()">
            Cancelar
          </button>
          <button class="btn-danger" onclick="confirmarExclusao()">
            üóëÔ∏è Excluir
          </button>
        </div>
      </div>
    </div>

    <script>
      // Vari√°veis globais
      let vendas = [];
      let caixaAberto = false;
      let webAppUrl = "";
      let proximoItem = 1;
      let vendaParaExcluir = null;

      // Inicializa√ß√£o
      document.addEventListener("DOMContentLoaded", function () {
        atualizarDataAtual();
        carregarConfiguracao();
        setInterval(atualizarDataAtual, 60000); // Atualiza a cada minuto
      });

      // Fun√ß√µes de configura√ß√£o
      function salvarConfiguracao() {
        const sheetUrl = document.getElementById("sheetUrl").value;
        const webAppUrlInput = document.getElementById("webAppUrl").value;

        if (!sheetUrl || !webAppUrlInput) {
          mostrarAlerta("Por favor, preencha ambos os campos.", "error");
          return;
        }

        localStorage.setItem("sheetUrl", sheetUrl);
        localStorage.setItem("webAppUrl", webAppUrlInput);
        webAppUrl = webAppUrlInput;

        document.getElementById("configSection").style.display = "none";
        mostrarAlerta("Configura√ß√£o salva com sucesso!", "success");
      }

      function carregarConfiguracao() {
        const sheetUrl = localStorage.getItem("sheetUrl");
        const savedWebAppUrl = localStorage.getItem("webAppUrl");

        if (sheetUrl && savedWebAppUrl) {
          document.getElementById("sheetUrl").value = sheetUrl;
          document.getElementById("webAppUrl").value = savedWebAppUrl;
          webAppUrl = savedWebAppUrl;
          document.getElementById("configSection").style.display = "none";
        }
      }

      // Fun√ß√µes de data e status
      function atualizarDataAtual() {
        const agora = new Date();
        const dataFormatada = agora.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        document.getElementById("dataAtual").textContent = dataFormatada;
      }

      function atualizarStatusCaixa() {
        const statusElement = document.getElementById("statusCaixa");
        const btnAbrirCaixa = document.getElementById("btnAbrirCaixa");

        if (caixaAberto) {
          statusElement.textContent = "Aberto";
          statusElement.style.color = "#4CAF50";
          btnAbrirCaixa.textContent = "üîí Fechar Caixa";
          btnAbrirCaixa.onclick = fecharCaixa;
        } else {
          statusElement.textContent = "Fechado";
          statusElement.style.color = "#f44336";
          btnAbrirCaixa.textContent = "üîì Abrir Caixa";
          btnAbrirCaixa.onclick = abrirCaixa;
        }
      }

      // Fun√ß√µes do caixa
      async function abrirCaixa() {
        if (!webAppUrl) {
          mostrarAlerta(
            "Configure primeiro a URL do Google Apps Script!",
            "error"
          );
          return;
        }

        const btn = document.getElementById("btnAbrirCaixa");
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>Abrindo Caixa...';

        try {
          const params = new URLSearchParams({
            action: "abrirCaixa",
            data: new Date().toISOString().split("T")[0],
          });

          const response = await fetch(`${webAppUrl}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          const result = await response.json();

          if (result.success) {
            caixaAberto = true;
            mostrarAlerta(
              "Caixa aberto com sucesso! Nova aba criada no Google Sheets.",
              "success"
            );
            document.getElementById("formSection").style.display = "block";
            document.getElementById("vendasList").style.display = "block";
            carregarVendasDoDia();
          } else {
            mostrarAlerta("Erro ao abrir caixa: " + result.message, "error");
          }
        } catch (error) {
          mostrarAlerta(
            "Erro de conex√£o. Verifique sua internet e as configura√ß√µes.",
            "error"
          );
          console.error("Erro:", error);
        } finally {
          btn.disabled = false;
          atualizarStatusCaixa();
        }
      }

      function fecharCaixa() {
        caixaAberto = false;
        document.getElementById("formSection").style.display = "none";
        document.getElementById("vendasList").style.display = "none";
        mostrarAlerta("Caixa fechado!", "success");
        atualizarStatusCaixa();
      }

      // Fun√ß√µes de vendas
      document
        .getElementById("vendaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const produto = document.getElementById("produto").value;
          const pagamento = document.getElementById("pagamento").value;
          const valor = parseFloat(document.getElementById("valor").value);
          const observacoes = document.getElementById("observacoes").value;

          if (!produto || !pagamento || !valor) {
            mostrarAlerta(
              "Por favor, preencha todos os campos obrigat√≥rios.",
              "error"
            );
            return;
          }

          const venda = {
            item: proximoItem++,
            produto: produto,
            pagamento: pagamento,
            valor: valor,
            observacoes: observacoes,
            timestamp: new Date().toISOString(),
          };

          // Adicionar √† lista local
          vendas.push(venda);

          // Enviar para o Google Sheets
          await enviarVendaParaSheets(venda);

          // Atualizar interface
          adicionarVendaATabela(venda);
          atualizarTotalVendas();
          limparFormulario();

          mostrarAlerta("Venda registrada com sucesso!", "success");
        });

      async function enviarVendaParaSheets(venda) {
        try {
          const params = new URLSearchParams({
            action: "adicionarVenda",
            venda: JSON.stringify(venda),
          });

          const response = await fetch(`${webAppUrl}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error("Erro ao enviar venda:", error);
          mostrarAlerta(
            "Venda salva localmente, mas n√£o foi poss√≠vel sincronizar com o Google Sheets.",
            "warning"
          );
        }
      }

      async function excluirVendaDoSheets(item) {
        try {
          const params = new URLSearchParams({
            action: "excluirVenda",
            item: item,
            data: new Date().toISOString().split("T")[0],
          });

          const response = await fetch(`${webAppUrl}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message);
          }
          return result;
        } catch (error) {
          console.error("Erro ao excluir venda:", error);
          throw error;
        }
      }

      function adicionarVendaATabela(venda) {
        const tbody = document.getElementById("vendasTableBody");
        const row = tbody.insertRow();
        row.id = `venda-${venda.item}`;

        row.innerHTML = `
                <td>${venda.item}</td>
                <td>${venda.produto}</td>
                <td>${venda.pagamento}</td>
                <td>R$ ${venda.valor.toFixed(2).replace(".", ",")}</td>
                <td>${venda.observacoes}</td>
                <td>
                    <button class="btn-danger btn-small" onclick="abrirModalExclusao(${
                      venda.item
                    })">
                        üóëÔ∏è Excluir
                    </button>
                </td>
            `;
      }

      function atualizarTotalVendas() {
        const total = vendas.reduce((sum, venda) => sum + venda.valor, 0);
        document.getElementById("totalVendas").textContent = `R$ ${total
          .toFixed(2)
          .replace(".", ",")}`;
        document.getElementById("vendasDia").textContent = vendas.length;
      }

      function limparFormulario() {
        document.getElementById("vendaForm").reset();
      }

      async function carregarVendasDoDia() {
        try {
          const params = new URLSearchParams({
            action: "carregarVendas",
            data: new Date().toISOString().split("T")[0],
          });

          const response = await fetch(`${webAppUrl}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          const result = await response.json();
          if (result.success && result.vendas) {
            vendas = result.vendas;
            proximoItem = vendas.length + 1;

            // Limpar tabela e recarregar
            const tbody = document.getElementById("vendasTableBody");
            tbody.innerHTML = "";

            vendas.forEach((venda) => {
              adicionarVendaATabela(venda);
            });

            atualizarTotalVendas();
          }
        } catch (error) {
          console.error("Erro ao carregar vendas:", error);
        }
      }

      // Fun√ß√µes de interface
      function mostrarAlerta(mensagem, tipo) {
        const alertContainer = document.getElementById("alertContainer");
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${tipo}`;
        alertDiv.textContent = mensagem;

        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      // Fun√ß√µes de exclus√£o
      function abrirModalExclusao(item) {
        const venda = vendas.find((v) => v.item === item);
        if (!venda) return;

        vendaParaExcluir = venda;

        const detalhes = document.getElementById("vendaDetalhes");
        detalhes.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <strong>Item:</strong> ${venda.item}<br>
                    <strong>Produto:</strong> ${venda.produto}<br>
                    <strong>Valor:</strong> R$ ${venda.valor
                      .toFixed(2)
                      .replace(".", ",")}<br>
                    <strong>Pagamento:</strong> ${venda.pagamento}
                </div>
            `;

        document.getElementById("modalExclusao").style.display = "block";
      }

      function fecharModal() {
        document.getElementById("modalExclusao").style.display = "none";
        vendaParaExcluir = null;
      }

      async function confirmarExclusao() {
        if (!vendaParaExcluir) return;

        const btnExcluir = document.querySelector(".modal-buttons .btn-danger");
        btnExcluir.disabled = true;
        btnExcluir.innerHTML = '<span class="loading"></span>Excluindo...';

        try {
          // Excluir do Google Sheets
          await excluirVendaDoSheets(vendaParaExcluir.item);

          // Excluir da lista local
          vendas = vendas.filter((v) => v.item !== vendaParaExcluir.item);

          // Remover da tabela
          const row = document.getElementById(`venda-${vendaParaExcluir.item}`);
          if (row) {
            row.remove();
          }

          // Atualizar totais
          atualizarTotalVendas();

          // Fechar modal
          fecharModal();

          mostrarAlerta("Venda exclu√≠da com sucesso!", "success");
        } catch (error) {
          mostrarAlerta("Erro ao excluir venda. Tente novamente.", "error");
          console.error("Erro ao excluir:", error);
        } finally {
          btnExcluir.disabled = false;
          btnExcluir.innerHTML = "üóëÔ∏è Excluir";
        }
      }

      // Fechar modal ao clicar fora
      window.onclick = function (event) {
        const modal = document.getElementById("modalExclusao");
        if (event.target === modal) {
          fecharModal();
        }
      };

      // Inicializar status do caixa
      atualizarStatusCaixa();
    </script>
  </body>
</html>
