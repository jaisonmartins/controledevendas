<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Controle de Vendas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- ...existing code... -->
    <link rel="icon" type="image/png" href="cash-register.png" />
    <!-- √çcone para Android/Chrome -->
    <link rel="icon" sizes="192x192" href="cashier-192.png" />
    <link rel="icon" sizes="512x512" href="cashier-512.png" />
    <!-- √çcone para iOS (Apple Touch Icon) -->
    <link rel="apple-touch-icon" sizes="180x180" href="cashier-180.png" />
    <!-- Manifest para PWA (opcional, mas recomendado) -->
    <link rel="manifest" href="manifest.json" />
    <!-- ...existing code... -->

    <style>
      * {
        font-family: "Inter", sans-serif;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
        --dark-gradient: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      }

      .gradient-primary {
        background: var(--primary-gradient);
      }

      .gradient-success {
        background: var(--success-gradient);
      }

      .gradient-warning {
        background: var(--warning-gradient);
      }

      .gradient-danger {
        background: var(--danger-gradient);
      }

      .gradient-dark {
        background: var(--dark-gradient);
      }

      .floating-card {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .floating-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .slide-in {
        animation: slideIn 0.6s ease-out;
      }

      @keyframes slideIn {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading-spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .category-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .category-acessorios {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .category-brinquedos {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }

      .category-badge:not(.category-acessorios):not(.category-brinquedos) {
        background: linear-gradient(135deg, #2d8cf8 0%, #004f70 100%);
        color: #ffffff;
      }

      .modern-input {
        transition: all 0.3s ease;
        border: 2px solid #e2e8f0;
        background: white;
      }

      .modern-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
      }

      .modern-button {
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.025em;
      }

      .modern-button:hover {
        transform: translateY(-2px);
      }

      .modern-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .modern-button:disabled:hover {
        transform: none !important;
      }

      .stats-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .modal-backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .alert-modern {
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        animation: slideIn 0.3s ease-out;
      }

      .alert-success {
        background: #f0fff4;
        border-color: #48bb78;
        color: #22543d;
      }

      .alert-error {
        background: #fef5e7;
        border-color: #f56565;
        color: #742a2a;
      }

      .alert-warning {
        background: #fffbeb;
        border-color: #ed8936;
        color: #7c2d12;
      }

      #statusDashboard {
        transition: all 0.5s ease-in-out;
      }

      .bounce-in {
        animation: bounceIn 0.8s ease-out;
      }

      @keyframes bounceIn {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Melhorias para tablets e smartphones */
      @media (max-width: 768px) {
        .gradient-primary {
          padding: 1.5rem !important;
        }
        .gradient-primary h1 {
          font-size: 1.75rem !important;
          line-height: 1.2;
        }
        .gradient-primary p {
          font-size: 0.9rem !important;
        }
        .grid.md\\:grid-cols-2.lg\\:grid-cols-3 {
          grid-template-columns: 1fr !important;
          gap: 1rem !important;
        }
        .grid.md\\:grid-cols-3 {
          grid-template-columns: 1fr !important;
        }
        .modern-input {
          padding: 1rem !important;
          font-size: 1rem !important;
          min-height: 48px;
        }
        .modern-button {
          padding: 0.875rem 1.5rem !important;
          font-size: 0.95rem !important;
          min-height: 48px;
          width: 100%;
          margin-bottom: 0.5rem;
        }
        .modal-backdrop .bg-white {
          margin: 1rem;
          max-height: 90vh;
          overflow-y: auto;
        }
        .overflow-x-auto {
          -webkit-overflow-scrolling: touch;
        }
        table {
          min-width: 700px;
        }
        th,
        td {
          padding: 0.75rem 0.5rem !important;
          font-size: 0.875rem !important;
        }
        .stats-card {
          margin-bottom: 1rem;
          text-align: center;
        }
        .alert-modern {
          font-size: 0.9rem;
          padding: 1rem !important;
        }
        .floating-card:hover {
          transform: translateY(-2px) !important;
        }
      }

      @media (max-width: 480px) {
        /* Esconde textos extras do header no mobile */
        .dashboard-infos-mobile {
          display: none !important;
        }
        .max-w-7xl {
          padding-left: 0.5rem !important;
          padding-right: 0.5rem !important;
        }
        .gradient-primary h1 {
          font-size: 1.2rem !important;
        }
        /* Cards menores e lado a lado */
        .stats-card {
          padding: 0.75rem !important;
          margin-bottom: 0.5rem !important;
          font-size: 0.85rem !important;
          min-width: 110px;
          max-width: 120px;
          display: inline-block !important;
          vertical-align: top;
        }
        #statusDashboard {
          text-align: center;
        }
        #statusDashboard .grid {
          display: flex !important;
          flex-direction: row !important;
          justify-content: center;
          gap: 1rem !important;
        }
        /* Bot√£o dashboard sempre vis√≠vel */
        .gradient-primary .hidden.md\:flex {
          display: flex !important;
        }
        /* Oculta colunas extras, mas mant√©m a coluna A√ß√µes vis√≠vel */
        table th:nth-child(n + 6):not(:last-child),
        table td:nth-child(n + 6):not(:last-child) {
          display: none;
        }
        .modal-backdrop .bg-white {
          margin: 0.5rem;
          border-radius: 1rem;
        }
        .text-xs.px-3.py-1 {
          padding: 0.5rem 0.75rem !important;
          font-size: 0.75rem !important;
        }
      }

      .btn-icone {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
        border: none;
        box-shadow: none;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-icone:focus {
        outline: 2px solid #667eea;
        outline-offset: 2px;
      }
      .text-jm {
        font-size: 1rem !important;
        line-height: 1rem !important;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50">
    <!-- Preloader -->
    <div
      id="preloader"
      class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white transition-opacity duration-700"
      style="opacity: 1"
    >
      <div class="flex flex-col items-center">
        <div class="mb-4">
          <img
            src="cash-register.png"
            alt="Logo"
            class="w-16 h-16 animate-bounce"
          />
        </div>
        <div
          class="text-xl font-bold text-blue-600 mb-2 tracking-wide"
          id="preloaderText"
        >
          Carregando
        </div>
        <div class="w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            id="preloaderBar"
            class="h-2 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full transition-all duration-700"
            style="width: 0%"
          ></div>
        </div>
      </div>
    </div>
    <!-- Background Pattern -->
    <div class="fixed inset-0 opacity-5 pointer-events-none">
      <div
        class="absolute inset-0"
        style="
          background-image: radial-gradient(
            circle at 1px 1px,
            #667eea 1px,
            transparent 0
          );
          background-size: 20px 20px;
        "
      ></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-7xl mx-auto px-4 py-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <div
          class="gradient-primary rounded-2xl p-8 text-white shadow-2xl floating-card"
        >
          <div
            class="flex flex-col items-center justify-center mb-4 md:flex-row md:mb-4"
          >
            <div
              class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mb-2 md:mb-0 md:mr-4"
            >
              <i class="fas fa-cash-register text-3xl"></i>
            </div>
            <div>
              <h1 class="text-3xl md:text-4xl font-bold mb-2">
                Sistema de Controle de Vendas
              </h1>
              <p class="text-base md:text-xl opacity-90">
                Gerencie suas vendas com intelig√™ncia e eleg√¢ncia
              </p>
            </div>
          </div>
          <div
            class="flex items-center justify-center space-x-4 text-sm mt-4 md:mt-0 hidden md:flex"
          >
            <div
              class="bg-white bg-opacity-20 rounded-full px-4 py-2 dashboard-infos-mobile"
            >
              <i class="fas fa-cloud mr-2"></i>
              Integra√ß√£o Google Sheets
            </div>
            <div
              class="bg-white bg-opacity-20 rounded-full px-4 py-2 dashboard-infos-mobile"
            >
              <i class="fas fa-chart-line mr-2"></i>
              Controle em Tempo Real
            </div>
            <button
              onclick="window.open('dashboard.html')"
              class="bg-white bg-opacity-30 hover:bg-opacity-50 rounded-full px-4 py-2 flex items-center transition-all duration-200 shadow-md"
            >
              <i class="fas fa-tachometer-alt mr-2"></i>
              Acessar Dashboard
            </button>
          </div>
        </div>
      </div>

      <!-- Status Dashboard -->
      <div
        id="statusDashboard"
        class="mb-8 transition-all duration-500 ease-in-out"
      >
        <div class="grid md:grid-cols-3 gap-6">
          <div class="stats-card text-center" id="card-data">
            <div
              class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <i class="fas fa-calendar-alt text-blue-600 text-xl"></i>
            </div>
            <h3 class="text-sm font-semibold text-gray-600 mb-1">Data Atual</h3>
            <div id="dataAtual" class="text-lg font-bold text-gray-800">--</div>
          </div>
          <div class="stats-card text-center" id="card-vendas">
            <div
              class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <i class="fas fa-shopping-cart text-purple-600 text-xl"></i>
            </div>
            <h3 class="text-sm font-semibold text-gray-600 mb-1">V. do Dia</h3>
            <div id="vendasDia" class="text-lg font-bold text-purple-600">
              0
            </div>
          </div>
          <div class="stats-card text-center" id="card-total">
            <div
              class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
            </div>
            <h3 class="text-sm font-semibold text-gray-600 mb-1">
              Valor Total
            </h3>
            <div id="valorTotal" class="text-2xl font-bold text-jm mt-1">
              R$ 0,00
            </div>
          </div>
        </div>
        <!-- Bot√£o removido daqui, ser√° colocado fora do statusDashboard -->
      </div>
      <!-- Bot√£o Ocultar/Mostrar Cards sempre fixo no mobile -->
      <!-- Bot√£o Ocultar/Mostrar Cards fixo no topo no mobile -->
      <div class="w-full flex justify-center md:hidden">
        <button
          class="text-xs px-3 py-2 bg-gray-300 rounded flex items-center gap-2 fixed top-0 left-1/2 transform -translate-x-1/2 mt-2 z-50 shadow-lg"
          id="btnOcultarTodosCards"
          style="display: block"
        >
          <i class="fas fa-eye-slash"></i>
          Ocultar Cards
        </button>
      </div>

      <!-- Alerts Container -->
      <div id="alertContainer" class="mb-8"></div>

      <!-- Sales Form - OCULTO INICIALMENTE -->
      <div id="formSection" class="mb-8 hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8 floating-card">
          <div class="flex items-center mb-6">
            <div
              class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4"
            >
              <i class="fas fa-plus text-blue-600 text-xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">
              Registrar Nova Venda
            </h2>
          </div>

          <form id="vendaForm">
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-box mr-2"></i>Produto
                </label>
                <input
                  type="text"
                  id="produto"
                  required
                  class="w-full px-4 py-3 rounded-lg modern-input"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-tags mr-2"></i>Categoria
                </label>
                <select
                  id="categoria"
                  required
                  class="w-full px-4 py-3 rounded-lg modern-input"
                >
                  <option value="">Selecione...</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-credit-card mr-2"></i>Tipo de Pagamento
                </label>
                <select
                  id="pagamento"
                  required
                  class="w-full px-4 py-3 rounded-lg modern-input"
                >
                  <option value="">Selecione...</option>
                  <option value="Dinheiro">üí∏ Dinheiro</option>
                  <option value="Cart√£o de D√©bito">üí≥ Cart√£o de D√©bito</option>
                  <option value="Cart√£o de Cr√©dito">
                    üí≥ Cart√£o de Cr√©dito
                  </option>
                  <option value="PIX">üì± PIX</option>
                  <option value="Boleto">üìÑ Boleto</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-dollar-sign mr-2"></i>Valor (R$)
                </label>
                <input
                  type="text"
                  id="valor"
                  step="0.01"
                  min="0"
                  required
                  class="w-full px-4 py-3 rounded-lg modern-input"
                />
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-comment mr-2"></i>Observa√ß√µes
                </label>
                <textarea
                  id="observacoes"
                  rows="3"
                  class="w-full px-4 py-3 rounded-lg modern-input"
                  placeholder="Informa√ß√µes adicionais..."
                ></textarea>
              </div>
            </div>

            <div class="text-center mt-6">
              <button
                id="btnAdicionarVenda"
                type="submit"
                class="gradient-success text-white px-8 py-4 rounded-xl text-lg font-semibold modern-button"
              >
                <i class="fas fa-plus mr-2"></i>Adicionar Venda
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Sales List -->
      <div id="vendasList" class="mb-8 hidden">
        <div
          class="bg-white rounded-2xl shadow-lg overflow-hidden floating-card"
        >
          <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 border-b">
            <div class="flex items-center">
              <div
                class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4"
              >
                <i class="fas fa-list text-green-600 text-xl"></i>
              </div>
              <h2 class="text-2xl font-bold text-gray-800">Vendas de Hoje</h2>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-50">
                  <!-- <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Item
                  </th>-->
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Produto
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Valor
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Pagamento
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Categoria
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    Observa√ß√µes
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                  >
                    A√ß√µes
                  </th>
                </tr>
              </thead>
              <tbody
                id="vendasTableBody"
                class="bg-white divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>

          <div class="gradient-primary p-6 text-white text-center">
            <h3 class="text-lg font-semibold mb-2">
              üí∞ Total de Vendas do Dia
            </h3>
            <div id="totalVendas" class="text-3xl font-bold">R$ 0,00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Exclus√£o -->
    <div
      id="modalExclusao"
      class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 bounce-in"
      >
        <div class="text-center">
          <div
            class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">
            Confirmar Exclus√£o
          </h3>
          <p class="text-gray-600 mb-6">
            Tem certeza que deseja excluir esta venda?
          </p>
          <div id="vendaDetalhes" class="mb-6"></div>
          <div class="flex space-x-4">
            <button
              onclick="fecharModal()"
              class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg modern-button"
            >
              <i class="fas fa-times mr-2"></i>Cancelar
            </button>
            <button
              id="btnConfirmarExclusao"
              onclick="confirmarExclusao()"
              class="flex-1 gradient-danger text-white px-6 py-3 rounded-lg modern-button"
            >
              <i class="fas fa-trash mr-2"></i>Excluir
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Venda -->
    <div
      id="modalEditar"
      class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 bounce-in"
      >
        <div class="text-center">
          <div
            class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-edit text-blue-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Editar Venda</h3>
          <p class="text-gray-600 mb-4">
            Altere os dados da venda conforme necess√°rio
          </p>
        </div>
        <form id="formEditarVenda">
          <div class="grid gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-box mr-2"></i>Produto
              </label>
              <input
                type="text"
                id="editarProduto"
                required
                class="w-full px-4 py-3 rounded-lg modern-input"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-tags mr-2"></i>Categoria
              </label>
              <select
                id="editarCategoria"
                required
                class="w-full px-4 py-3 rounded-lg modern-input"
              >
                <option value="">Selecione...</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-credit-card mr-2"></i>Tipo de Pagamento
              </label>
              <select
                id="editarPagamento"
                required
                class="w-full px-4 py-3 rounded-lg modern-input"
              >
                <option value="">Selecione...</option>
                <option value="Dinheiro">üí∏ Dinheiro</option>
                <option value="Cart√£o de D√©bito">üí≥ Cart√£o de D√©bito</option>
                <option value="Cart√£o de Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
                <option value="PIX">üì± PIX</option>
                <option value="Boleto">üìÑ Boleto</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-dollar-sign mr-2"></i>Valor (R$)
              </label>
              <input
                type="text"
                id="editarValor"
                step="0.01"
                min="0"
                required
                class="w-full px-4 py-3 rounded-lg modern-input"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-comment mr-2"></i>Observa√ß√µes
              </label>
              <textarea
                id="editarObservacoes"
                rows="3"
                class="w-full px-4 py-3 rounded-lg modern-input"
                placeholder="Informa√ß√µes adicionais..."
              ></textarea>
            </div>
          </div>

          <div class="text-center mt-6">
            <button
              id="btnSalvarEdicao"
              type="submit"
              class="gradient-success text-white px-8 py-4 rounded-xl text-lg font-semibold modern-button"
            >
              <i class="fas fa-save mr-2"></i>Salvar Edi√ß√£o
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { WEBAPP_URL } from "./conexao.js";

      // PRELOADER ANIMA√á√ÉO

      // Preloader com progresso real
      let etapaPreloader = 0;
      const etapasTotal = 3; // abrir caixa, categorias, vendas
      function atualizarPreloader(etapa, texto) {
        const text = document.getElementById("preloaderText");
        const bar = document.getElementById("preloaderBar");
        if (text) text.textContent = texto;
        if (bar)
          bar.style.width = Math.round((etapa / etapasTotal) * 100) + "%";
      }
      function finalizarPreloader() {
        const preloader = document.getElementById("preloader");
        if (preloader) {
          preloader.style.opacity = "0";
          setTimeout(() => {
            preloader.style.display = "none";
          }, 700);
        }
      }

      // Inicia o preloader ao carregar a p√°gina
      window.addEventListener("DOMContentLoaded", () => {
        atualizarPreloader(0, "Carregando sistema...");
      });

      // Vari√°veis globais
      let vendas = [];
      let caixaAberto = false;
      let vendaParaExcluir = null;
      let itemSendoEditado = null;
      let categorias = [];

      // Inicializa√ß√£o autom√°tica quando a p√°gina carregar
      window.addEventListener("DOMContentLoaded", async () => {
        // Exibe bot√£o de ocultar todos os cards no mobile
        if (window.innerWidth <= 480) {
          const btnOcultarTodos = document.getElementById(
            "btnOcultarTodosCards"
          );
          btnOcultarTodos.style.display = "block";
          let dashboardVisivel = true;
          btnOcultarTodos.onclick = function () {
            const dashboard = document.getElementById("statusDashboard");
            if (dashboardVisivel) {
              dashboard.style.display = "none";
              btnOcultarTodos.innerHTML =
                '<i class="fas fa-eye"></i> Mostrar Cards';
              dashboardVisivel = false;
            } else {
              dashboard.style.display = "";
              btnOcultarTodos.innerHTML =
                '<i class="fas fa-eye-slash"></i> Ocultar Cards';
              dashboardVisivel = true;
            }
          };
        }
        console.log("üöÄ Inicializando Sistema de Vendas...");

        atualizarDataAtual();

        if (!WEBAPP_URL) {
          mostrarAlerta("‚ùå URL do backend n√£o configurada!", "error");
          finalizarPreloader();
          return;
        }

        try {
          atualizarPreloader(0, "Conectando ao sistema...");
          await abrirCaixa();
          etapaPreloader = 1;
          atualizarPreloader(etapaPreloader, "Carregando categorias...");
          await carregarCategorias();
          etapaPreloader = 2;
          atualizarPreloader(etapaPreloader, "Carregando vendas do dia...");
          await carregarVendasDoDia();
          etapaPreloader = 3;
          atualizarPreloader(etapaPreloader, "Finalizando...");
          console.log("‚úÖ Sistema inicializado com sucesso!");
        } catch (error) {
          console.error("‚ùå Erro na inicializa√ß√£o:", error);
          mostrarAlerta("Erro na inicializa√ß√£o: " + error.message, "error");
        } finally {
          finalizarPreloader();
        }
      });

      // Fun√ß√£o para abrir caixa (inicializar sistema) - MODIFICADA
      async function abrirCaixa() {
        try {
          const params = new URLSearchParams({ action: "abrirCaixa" });
          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            caixaAberto = true;
            mostrarAlerta(
              "‚úÖ Sistema inicializado! Conectado √† planilha.",
              "success"
            );
            await carregarCategorias();
            await carregarVendasDoDia();

            // üéØ MOSTRA O FORMUL√ÅRIO AP√ìS INICIALIZA√á√ÉO COMPLETA
            mostrarFormulario();
            mostrarVendasList();
          } else {
            mostrarAlerta(
              "‚ùå Erro ao inicializar: " +
                (result.message || "Erro desconhecido"),
              "error"
            );
          }
        } catch (error) {
          console.error("Erro completo:", error);
          mostrarAlerta("‚ùå Erro de conex√£o: " + error.message, "error");
        }
      }

      // üéØ NOVA FUN√á√ÉO para mostrar o formul√°rio
      function mostrarFormulario() {
        const formSection = document.getElementById("formSection");
        formSection.classList.remove("hidden");
        formSection.classList.add("slide-in");

        console.log("‚úÖ Formul√°rio exibido - Sistema pronto para uso!");
        mostrarAlerta(
          "üéâ Sistema pronto! Voc√™ pode registrar vendas agora.",
          "success"
        );
      }

      // üéØ NOVA FUN√á√ÉO para mostrar a lista de vendas
      function mostrarVendasList() {
        const vendasList = document.getElementById("vendasList");
        vendasList.classList.remove("hidden");
        vendasList.classList.add("slide-in");

        console.log("‚úÖ Lista de vendas exibida - Sistema pronto para uso!");
      }

      // Fun√ß√£o para carregar categorias - SIMPLIFICADA
      async function carregarCategorias() {
        try {
          const params = new URLSearchParams({ action: "carregarCategorias" });
          console.log("üìÇ Carregando categorias...");

          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("üìÇ Categorias carregadas:", result);

          if (
            result.success &&
            Array.isArray(result.categorias) &&
            result.categorias.length > 0
          ) {
            categorias = result.categorias;
            atualizarSelectCategorias();
            atualizarSelectCategorias("editarCategoria");
            console.log(`‚úÖ ${categorias.length} categorias carregadas`);
          } else {
            categorias = [];
            atualizarSelectCategoriasVazio();
            console.log(
              "‚ö†Ô∏è Nenhuma categoria encontrada - usando categoria padr√£o"
            );
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar categorias:", error);
          categorias = [];
          atualizarSelectCategoriasVazio();
          console.log("‚ùå Erro nas categorias - usando categoria padr√£o");
        }
      }

      // Fun√ß√£o para atualizar select de categorias
      function atualizarSelectCategorias(selectId = "categoria") {
        const selectCategoria = document.getElementById(selectId);

        if (!selectCategoria) {
          console.warn(`Select ${selectId} n√£o encontrado`);
          return;
        }

        // Remove todas as op√ß√µes exceto a primeira
        while (selectCategoria.children.length > 1) {
          selectCategoria.removeChild(selectCategoria.lastChild);
        }

        // Atualiza texto da primeira op√ß√£o
        selectCategoria.firstElementChild.textContent = "Selecione...";

        // Adiciona as categorias
        categorias.forEach((categoria) => {
          const option = document.createElement("option");
          option.value = categoria;
          option.textContent = categoria;
          selectCategoria.appendChild(option);
        });
      }

      // Nova fun√ß√£o para quando n√£o h√° categorias
      function atualizarSelectCategoriasVazio(selectId = "categoria") {
        const selectCategoria = document.getElementById(selectId);

        if (!selectCategoria) {
          console.warn(`Select ${selectId} n√£o encontrado`);
          return;
        }

        // Remove todas as op√ß√µes exceto a primeira
        while (selectCategoria.children.length > 1) {
          selectCategoria.removeChild(selectCategoria.lastChild);
        }

        // Atualiza texto da primeira op√ß√£o para indicar que precisa cadastrar
        selectCategoria.firstElementChild.textContent =
          "Cadastre categorias na planilha";
        selectCategoria.firstElementChild.value = "";

        // Adiciona op√ß√£o tempor√°ria para permitir uso b√°sico
        const optionTemp = document.createElement("option");
        optionTemp.value = "Geral";
        optionTemp.textContent = "üè∑Ô∏è Geral (tempor√°rio)";
        selectCategoria.appendChild(optionTemp);

        // Faz a mesma coisa para o select de edi√ß√£o se for o principal
        if (selectId === "categoria") {
          atualizarSelectCategoriasVazio("editarCategoria");
        }
      }

      // REMOVE a fun√ß√£o habilitarFormularioVenda (n√£o √© mais necess√°ria)

      // Event listener para formul√°rio de venda - MODIFICADO
      document
        .getElementById("vendaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const produto = document.getElementById("produto").value.trim();
          const categoria = document.getElementById("categoria").value;
          const pagamento = document.getElementById("pagamento").value;
          const valorString = document.getElementById("valor").value.trim();
          // Extrai o valor num√©rico da m√°scara
          const valorNumerico = valorString
            .replace(/[^\d,]/g, "")
            .replace(",", ".");
          const valor = parseFloat(valorNumerico);
          if (isNaN(valor) || valor <= 0) {
            mostrarAlerta("‚ö†Ô∏è Preencha o campo Valor corretamente!", "error");
            return;
          }
          const observacoes = document
            .getElementById("observacoes")
            .value.trim();

          // Valida√ß√£o espec√≠fica para categorias
          if (!categoria) {
            mostrarAlerta(
              "‚ö†Ô∏è Selecione uma categoria ou cadastre uma na planilha!",
              "error"
            );
            return;
          }

          if (!produto || !pagamento || !valor || valor <= 0) {
            mostrarAlerta("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!", "error");
            return;
          }

          const btnAdicionar = document.getElementById("btnAdicionarVenda");
          btnAdicionar.disabled = true;
          btnAdicionar.innerHTML =
            '<i class="fas fa-spinner loading-spinner mr-2"></i>Adicionando...';

          try {
            const venda = {
              produto: produto,
              categoria: categoria,
              pagamento: pagamento,
              valor: valor,
              observacoes: observacoes,
              timestamp: new Date().toISOString(),
            };

            console.log("üíæ Enviando venda:", venda);
            const resultado = await enviarVendaParaSheets(venda);

            // Adiciona o n√∫mero do item retornado pelo backend
            venda.item = resultado.item;

            // Adiciona a nova venda no in√≠cio do array para manter a ordem cronol√≥gica reversa
            vendas.unshift(venda);

            // Limpa a tabela
            const tbody = document.getElementById("vendasTableBody");
            tbody.innerHTML = "";

            // Recarrega todas as vendas na ordem correta
            vendas.forEach((v) => {
              adicionarVendaATabela(v);
            });

            atualizarTotalVendas();
            limparFormulario();
            mostrarAlerta("‚úÖ Venda registrada com sucesso!", "success");
          } catch (error) {
            console.error("‚ùå Erro ao adicionar venda:", error);
            mostrarAlerta("‚ùå Erro ao registrar: " + error.message, "error");
          } finally {
            btnAdicionar.disabled = false;
            btnAdicionar.innerHTML =
              '<i class="fas fa-plus mr-2"></i>Adicionar Venda';
          }
        });

      // Fun√ß√£o para enviar venda para Google Sheets
      async function enviarVendaParaSheets(venda) {
        try {
          const params = new URLSearchParams({
            action: "adicionarVenda",
            venda: JSON.stringify(venda),
          });

          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(
              result.message || "Erro desconhecido ao enviar venda"
            );
          }

          return result;
        } catch (error) {
          console.error("‚ùå Erro ao enviar venda:", error);
          throw error;
        }
      }

      // Fun√ß√£o para adicionar venda √† tabela
      function adicionarVendaATabela(venda) {
        const tbody = document.getElementById("vendasTableBody");
        const row = tbody.insertRow();
        row.id = `venda-${venda.item}`;
        row.className = "hover:bg-gray-50 transition-colors";

        // Cria a categoria class name
        const categoriaClass = venda.categoria
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]/g, "");

        //<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${venda.item}</td> JM - essa parte √© tabela

        row.innerHTML = `

          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
            venda.produto
          }</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">R$ ${venda.valor
            .toFixed(2)
            .replace(".", ",")}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
            venda.pagamento
          }</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="category-badge category-${categoriaClass}">${
          venda.categoria
        }</span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${
            venda.observacoes || "-"
          }</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm flex gap-2">
            <button onclick="abrirModalEditar(${
              venda.item
            })" class="btn-icone bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full p-2 transition-all duration-200" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="abrirModalExclusao(${
              venda.item
            })" class="btn-icone bg-red-100 hover:bg-red-200 text-red-600 rounded-full p-2 transition-all duration-200" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
      }

      // Fun√ß√£o para atualizar total de vendas
      function atualizarTotalVendas() {
        const total = vendas.reduce((sum, venda) => sum + venda.valor, 0);
        const totalFormatado = `R$ ${total.toFixed(2).replace(".", ",")}`;

        document.getElementById("valorTotal").textContent = totalFormatado;
        document.getElementById("totalVendas").textContent = totalFormatado;
        document.getElementById("vendasDia").textContent = vendas.length;
      }

      // Fun√ß√£o para limpar formul√°rio
      function limparFormulario() {
        document.getElementById("vendaForm").reset();
      }

      // Fun√ß√£o para carregar vendas do dia
      async function carregarVendasDoDia() {
        try {
          const hoje = new Date();
          const dataFormatada =
            hoje.getFullYear() +
            "-" +
            String(hoje.getMonth() + 1).padStart(2, "0") +
            "-" +
            String(hoje.getDate()).padStart(2, "0");

          const params = new URLSearchParams({
            action: "carregarVendas",
            data: dataFormatada,
          });

          console.log("üìä Carregando vendas do dia...");

          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success && result.vendas) {
            // Filtra e ordena as vendas por timestamp (mais recentes primeiro)
            vendas = result.vendas
              .filter(
                (venda) =>
                  venda.item &&
                  venda.produto &&
                  venda.categoria &&
                  venda.pagamento &&
                  venda.valor
              )
              .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tbody = document.getElementById("vendasTableBody");
            tbody.innerHTML = "";

            vendas.forEach((venda) => {
              adicionarVendaATabela(venda);
            });

            atualizarTotalVendas();
            console.log(`‚úÖ ${vendas.length} vendas carregadas para hoje`);
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar vendas:", error);
          mostrarAlerta(
            "‚ö†Ô∏è Erro ao carregar vendas: " + error.message,
            "warning"
          );
        }
      }

      // Fun√ß√£o para mostrar alertas
      function mostrarAlerta(mensagem, tipo) {
        const alertContainer = document.getElementById("alertContainer");
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert-modern alert-${tipo}`;

        const icon =
          tipo === "success"
            ? "check-circle"
            : tipo === "error"
            ? "exclamation-circle"
            : "exclamation-triangle";

        alertDiv.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-${icon} mr-3"></i>
            <span>${mensagem}</span>
          </div>
        `;

        alertContainer.appendChild(alertDiv);

        // Remove automaticamente ap√≥s 7 segundos
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 7000);
      }

      // Fun√ß√£o para atualizar data atual
      function atualizarDataAtual() {
        const hoje = new Date();
        const dataFormatada = hoje.toLocaleDateString("pt-BR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
        document.getElementById("dataAtual").textContent = dataFormatada;
      }

      // FUN√á√ïES DE MODAL DE EXCLUS√ÉO
      function abrirModalExclusao(item) {
        const venda = vendas.find((v) => v.item == item);
        if (!venda) {
          mostrarAlerta("‚ùå Venda n√£o encontrada!", "error");
          return;
        }

        vendaParaExcluir = venda;

        const detalhes = document.getElementById("vendaDetalhes");
        detalhes.innerHTML = `
          <div class="bg-gray-50 rounded-lg p-4 text-left">
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div><strong>Item:</strong> ${venda.item}</div>
              <div><strong>Produto:</strong> ${venda.produto}</div>
              <div><strong>Categoria:</strong> ${venda.categoria}</div>
              <div><strong>Valor:</strong> R$ ${venda.valor
                .toFixed(2)
                .replace(".", ",")}</div>
              <div class="col-span-2"><strong>Pagamento:</strong> ${
                venda.pagamento
              }</div>
              ${
                venda.observacoes
                  ? `<div class="col-span-2"><strong>Observa√ß√µes:</strong> ${venda.observacoes}</div>`
                  : ""
              }
            </div>
          </div>
        `;

        document.getElementById("modalExclusao").classList.remove("hidden");
      }

      function fecharModal() {
        document.getElementById("modalExclusao").classList.add("hidden");
        vendaParaExcluir = null;
      }

      async function confirmarExclusao() {
        if (!vendaParaExcluir) return;

        const btnExcluir = document.getElementById("btnConfirmarExclusao");
        btnExcluir.disabled = true;
        btnExcluir.innerHTML =
          '<i class="fas fa-spinner loading-spinner mr-2"></i>Excluindo...';

        try {
          await excluirVendaDoSheets(vendaParaExcluir.item);

          // Remove do array local
          vendas = vendas.filter((v) => v.item != vendaParaExcluir.item);

          // Remove da tabela
          const row = document.getElementById(`venda-${vendaParaExcluir.item}`);
          if (row) row.remove();

          atualizarTotalVendas();
          fecharModal();
          mostrarAlerta("‚úÖ Venda exclu√≠da com sucesso!", "success");
        } catch (error) {
          mostrarAlerta("‚ùå Erro ao excluir: " + error.message, "error");
        } finally {
          btnExcluir.disabled = false;
          btnExcluir.innerHTML = '<i class="fas fa-trash mr-2"></i>Excluir';
        }
      }

      async function excluirVendaDoSheets(item) {
        try {
          const params = new URLSearchParams({
            action: "excluirVenda",
            item: item,
          });

          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(
              result.message || "Erro desconhecido ao excluir venda"
            );
          }

          return result;
        } catch (error) {
          throw error;
        }
      }

      // FUN√á√ïES DE MODAL DE EDI√á√ÉO
      function abrirModalEditar(item) {
        console.log("üìù Abrindo modal de edi√ß√£o para item:", item);

        const venda = vendas.find((v) => v.item == item);
        if (!venda) {
          mostrarAlerta("‚ùå Venda n√£o encontrada!", "error");
          return;
        }

        console.log("üìã Venda encontrada:", venda);

        itemSendoEditado = item;

        // Atualiza as op√ß√µes de categoria no modal
        atualizarSelectCategorias("editarCategoria");

        // Preenche os campos
        document.getElementById("editarProduto").value = venda.produto;
        document.getElementById("editarCategoria").value = venda.categoria;
        document.getElementById("editarPagamento").value = venda.pagamento;
        document.getElementById("editarValor").value = venda.valor
          .toFixed(2)
          .replace(".", ",");
        document.getElementById("editarObservacoes").value =
          venda.observacoes || "";

        document.getElementById("modalEditar").classList.remove("hidden");
        console.log("‚úÖ Modal de edi√ß√£o aberto");
      }

      function fecharModalEditar() {
        document.getElementById("modalEditar").classList.add("hidden");
        itemSendoEditado = null;
        document.getElementById("formEditarVenda").reset();
      }

      // Event listener para formul√°rio de edi√ß√£o
      document
        .getElementById("formEditarVenda")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("üì§ Submetendo formul√°rio de edi√ß√£o...");

          if (!itemSendoEditado) {
            mostrarAlerta("‚ùå Item n√£o identificado!", "error");
            return;
          }

          const produto = document.getElementById("editarProduto").value.trim();
          const categoria = document
            .getElementById("editarCategoria")
            .value.trim();
          const pagamento = document
            .getElementById("editarPagamento")
            .value.trim();
          const valorString = document
            .getElementById("editarValor")
            .value.trim();
          // Extrai o valor num√©rico da m√°scara
          const valorNumerico = valorString
            .replace(/[^\d,]/g, "")
            .replace(",", ".");
          const valor = parseFloat(valorNumerico);
          if (isNaN(valor) || valor <= 0) {
            mostrarAlerta("‚ö†Ô∏è Preencha o campo Valor corretamente!", "error");
            return;
          }
          const observacoes = document
            .getElementById("editarObservacoes")
            .value.trim();

          console.log("üìã Dados do formul√°rio:", {
            produto,
            categoria,
            pagamento,
            valor,
            observacoes,
          });

          if (!produto || !categoria || !pagamento || !valor || valor <= 0) {
            mostrarAlerta("‚ö†Ô∏è Preencha todos os campos v√°lidos!", "error");
            return;
          }

          const btnSalvar = document.getElementById("btnSalvarEdicao");
          btnSalvar.disabled = true;
          btnSalvar.innerHTML =
            '<i class="fas fa-spinner loading-spinner mr-2"></i>Salvando...';

          try {
            const vendaEditada = {
              item: itemSendoEditado,
              produto,
              categoria,
              pagamento,
              valor,
              observacoes,
            };

            console.log("üíæ Enviando edi√ß√£o:", vendaEditada);
            await editarVendaNoSheets(vendaEditada);

            // Atualiza no array local
            const idx = vendas.findIndex((v) => v.item == itemSendoEditado);
            if (idx !== -1) {
              const timestampOriginal = vendas[idx].timestamp;
              vendas[idx] = { ...vendaEditada, timestamp: timestampOriginal };

              // Remove linha antiga e adiciona nova
              const row = document.getElementById(`venda-${itemSendoEditado}`);
              if (row) row.remove();

              adicionarVendaATabela(vendas[idx]);
              atualizarTotalVendas();
            }

            fecharModalEditar();
            mostrarAlerta("‚úÖ Venda editada com sucesso!", "success");

            // Recarrega as vendas para garantir sincroniza√ß√£o
            console.log("üîÑ Recarregando vendas para sincronizar...");
            setTimeout(async () => {
              await carregarVendasDoDia();
            }, 1000);
          } catch (error) {
            console.error("‚ùå Erro ao editar venda:", error);
            mostrarAlerta("‚ùå Erro ao editar: " + error.message, "error");
          } finally {
            btnSalvar.disabled = false;
            btnSalvar.innerHTML =
              '<i class="fas fa-save mr-2"></i>Salvar Edi√ß√£o';
          }
        });

      // Fun√ß√£o para editar venda no Google Sheets
      async function editarVendaNoSheets(vendaEditada) {
        try {
          console.log("üîß Editando venda:", vendaEditada);

          const params = new URLSearchParams({
            action: "editarVenda",
            venda: JSON.stringify(vendaEditada),
          });

          console.log("üåê Enviando para:", `${WEBAPP_URL}?${params}`);

          const response = await fetch(`${WEBAPP_URL}?${params}`, {
            method: "GET",
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("üì• Resultado da edi√ß√£o:", result);

          if (!result.success) {
            throw new Error(
              result.message || "Erro desconhecido ao editar venda"
            );
          }

          return result;
        } catch (error) {
          console.error("‚ùå Erro ao editar venda:", error);
          throw error;
        }
      }

      // M√ÅSCARAS DE FORMATA√á√ÉO
      // M√°scara de moeda para campo de valor
      function aplicarMascaraMoeda(input) {
        let valor = input.value.replace(/\D/g, ""); // Remove tudo que n√£o for d√≠gito
        valor = (parseInt(valor, 10) || 0).toString();
        if (valor.length < 3) valor = valor.padStart(3, "0");
        let reais = valor.slice(0, -2);
        let centavos = valor.slice(-2);
        reais = reais.replace(/^0+/, "");
        if (reais === "") reais = "0";
        input.value = `R$ ${reais},${centavos}`;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const campoValor = document.getElementById("valor");
        if (campoValor) {
          campoValor.addEventListener("input", function () {
            aplicarMascaraMoeda(this);
          });
          campoValor.addEventListener("blur", function () {
            aplicarMascaraMoeda(this);
          });
        }
        const campoValorEditar = document.getElementById("editarValor");
        if (campoValorEditar) {
          campoValorEditar.addEventListener("input", function () {
            aplicarMascaraMoeda(this);
          });
          campoValorEditar.addEventListener("blur", function () {
            aplicarMascaraMoeda(this);
          });
        }
      });

      // EVENT LISTENERS GLOBAIS
      // Fecha modais ao clicar fora
      window.addEventListener("click", function (event) {
        const modalExclusao = document.getElementById("modalExclusao");
        const modalEditar = document.getElementById("modalEditar");

        if (event.target === modalExclusao) {
          fecharModal();
        }

        if (event.target === modalEditar) {
          fecharModalEditar();
        }
      });

      // Atalhos de teclado
      document.addEventListener("keydown", function (event) {
        // ESC para fechar modais
        if (event.key === "Escape") {
          if (
            !document
              .getElementById("modalExclusao")
              .classList.contains("hidden")
          ) {
            fecharModal();
          }
          if (
            !document.getElementById("modalEditar").classList.contains("hidden")
          ) {
            fecharModalEditar();
          }
        }

        // Ctrl + N para focar no campo produto
        if (event.ctrlKey && event.key === "n") {
          event.preventDefault();
          const produtoInput = document.getElementById("produto");
          if (produtoInput) produtoInput.focus();
        }
      });

      // Torna as fun√ß√µes globais para uso nos bot√µes
      window.abrirModalExclusao = abrirModalExclusao;
      window.abrirModalEditar = abrirModalEditar;
      window.fecharModal = fecharModal;
      window.fecharModalEditar = fecharModalEditar;
      window.confirmarExclusao = confirmarExclusao;

      console.log("üéâ Sistema de Vendas carregado completamente!");
      console.log("üîß Funcionalidades dispon√≠veis:");
      console.log("  ‚úÖ Formul√°rio sempre vis√≠vel");
      console.log("  ‚úÖ Adicionar vendas");
      console.log("  ‚úÖ Editar vendas");
      console.log("  ‚úÖ Excluir vendas");
      console.log("  ‚úÖ Valida√ß√£o completa");
      console.log("  ‚úÖ Atalhos de teclado");
      console.log("  ‚úÖ M√°scaras de formata√ß√£o");
      console.log("üöÄ Sistema pronto para uso!");
    </script>
  </body>
</html>
